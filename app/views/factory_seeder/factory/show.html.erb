<div class="page-shell" data-factory-name="<%= @factory_name %>">
  <div class="scanlines"></div>
  <div class="grid-background"></div>
  <div class="page-content">
    <header class="section-title">Factory Â· <%= @factory_name %></header>
    <p class="hero__subtitle">
      Configure the execution parameters for this factory, toggle traits, and send the
      job to the generator.
    </p>

    <% if flash[:success] %>
      <div class="alert-message alert-message--success"><%= flash[:success] %></div>
    <% end %>

    <% if flash[:error] %>
      <div class="alert-message alert-message--error"><%= flash[:error] %></div>
    <% end %>

    <div class="factory-show-grid">
      <section class="panel">
        <div class="panel__header">
          <div>
            <div class="panel__title">Configuration</div>
            <div class="factory-card__meta">Class: <%= @factory[:class_name] %></div>
          </div>
          <%= link_to "Back", factory_index_path, class: "btn btn-accent" %>
        </div>

        <%= form_tag generate_factory_path(@factory_name), method: :post do %>
          <div class="panel__body">
            <div class="form-group">
              <label for="count">Records to generate</label>
              <%= number_field_tag :count, 1, min: 1, max: 100, class: "form-control" %>
            </div>

            <% traits = Array(@factory[:traits]) %>
            <% if traits.any? %>
              <div class="form-group">
                <label>Traits</label>
                <div class="trait-grid">
                  <% traits.each do |trait| %>
                    <label class="trait-checkbox">
                      <%= check_box_tag "selected_traits[]", trait, false, id: "trait_#{trait}" %>
                      <span><%= trait %></span>
                    </label>
                  <% end %>
                </div>
              </div>
            <% end %>

            <div class="form-group">
              <label>Associations</label>
              <p class="factory-card__meta">
                <%= Array(@factory[:associations]).map { |assoc| assoc[:name] }.join(', ').presence || 'None' %>
              </p>
            </div>

            <div class="form-group">
              <label>Attributes</label>
              <div class="attribute-grid">
                <% @factory[:attributes].each do |attr| %>
                  <div class="attribute-row">
                    <label for="attributes_<%= attr[:name] %>"><%= attr[:name] %> (<%= attr[:type] %>)</label>
                    <%= text_field_tag "attributes[#{attr[:name]}]", nil, class: "form-control", placeholder: "Use default" %>
                  </div>
                <% end %>
              </div>
            </div>

            <div class="form-actions">
              <%= submit_tag "Generate Seeds", class: "btn btn-primary" %>
            </div>
          </div>
        <% end %>
      </section>

      <section class="panel console">
        <div class="console__header">
          <span>Console Output</span>
          <span class="factory-card__meta">Live logs will appear once a job runs.</span>
        </div>
        <div class="console__body">
          <% logs = @execution_logs || [] %>
              <% if logs.any? %>
                <div class="space-y-1">
                  <% logs.each do |log| %>
                    <% entry = log.is_a?(Hash) ? log : log.to_h %>
                    <% message = entry['message'] || entry[:message] || entry.to_s %>
                    <% level = (entry['level'] || entry[:level] || :info).to_s %>
                    <% timestamp_value = entry['timestamp'] || entry[:timestamp] || Time.now %>
                    <% timestamp =
                      timestamp_value.respond_to?(:strftime) ? timestamp_value.strftime('%H:%M:%S') : timestamp_value.to_s %>
                    <div class="console-log console-log--<%= level %>">
                      <span class="text-muted-foreground">[<%= timestamp %>]</span>
                      <span><%= message %></span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="console-log">
                  <span>[ --:--:-- ]</span>Awaiting execution trigger...
                </div>
              <% end %>
        </div>
      </section>
    </div>
  </div>
</div>
